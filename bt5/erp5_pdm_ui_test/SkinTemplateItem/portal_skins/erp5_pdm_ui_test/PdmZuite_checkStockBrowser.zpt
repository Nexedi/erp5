<tal:block xmlns:tal="http://xml.zope.org/namespaces/tal"
           xmlns:metal="http://xml.zope.org/namespaces/metal">

  <tal:block metal:define-macro="init">
    <tal:block metal:use-macro="here/PdmZuite_CommonTemplate/macros/init" />
    <tr>
      <td>clickAndWait</td>
      <td>//button[@name="Base_doReport:method"]</td>
      <td></td>
    </tr>
  </tal:block>

  <tal:block
    metal:define-macro="check_inventory"
    tal:define="base_url python: '/' + here.getPortalObject().getId();
                select_node_category select_node_category | python: True">

    <tal:block tal:condition="select_node_category">
      <!-- Select node category in dialog -->
      <tr>
        <td>select</td>
        <td>//select[@name="field_your_node_category"]</td>
        <td tal:content='node_category'></td>
      </tr>
      <tr>
        <td>clickAndWait</td>
        <td>Base_callDialogMethod:method</td>
        <td></td>
      </tr>
    </tal:block>
    <tal:block tal:condition="not: select_node_category">
      <tr>
        <td>assertSelected</td>
        <td>//select[@name="field_your_node_category"]</td>
        <td tal:content='node_category'></td>
      </tr>
    </tal:block>

    <!-- Check inventory -->
    <tr>
      <td>verifyText</td>
      <td>//span[@class="listbox-current-page-total-number"]</td>
      <td tal:content="python: '%s records' % movement_count">number of record(s)</td>
    </tr>
    <tal:block tal:condition="python: movement_count != 0">

      <!-- Check that inventory and movement list are consistent -->
      <tal:block tal:repeat="inventory_tuple python: [(current_inventory, 3),
                                                      (available_inventory, 4),
                                                      (future_inventory, 5),
]">
        <tr>
          <td>verifyText</td>
          <td tal:content="python: '//tr[@class=\'listbox-data-line-0 DataA\']/td[%s]' % inventory_tuple[1]">inventory value</td>
          <td tal:content="python: inventory_tuple[0]">current inventory</td>
        </tr>
        <tr>
          <td>verifyText</td>
          <td tal:content="python: '//tr[@class=\'listbox_stat_line  listbox-stat-line\']/td[%s]' % inventory_tuple[1]">inventory value</td>
          <td tal:content="python: inventory_tuple[0]">current inventory</td>
        </tr>

        <!-- Check movement history list -->
        <tr>
          <td>clickAndWait</td>
          <td tal:content="python: '//tr[@class=\'listbox-data-line-0 DataA\']/td[%s]/a[1]' % inventory_tuple[1]">link</td>
          <td></td>
        </tr>
        <tr>
          <td>verifyText</td>
          <td>//span[@class="listbox-current-page-total-number"]</td>
          <td tal:content="python: '%s records' % int(abs(inventory_tuple[0]))">number of movement(s)</td>
        </tr>
        <!-- Go back to inventory view -->
        <tr>
          <td>clickAndWait</td>
          <td>//a[@class="listbox_title"]</td>
          <td></td>
        </tr>

        <tal:block tal:condition="select_node_category">
          <!-- Select node category in dialog (again) -->
          <tr>
            <td>select</td>
            <td>//select[@name="field_your_node_category"]</td>
            <td tal:content='node_category'></td>
          </tr>
          <tr>
            <td>clickAndWait</td>
            <td>Base_callDialogMethod:method</td>
            <td></td>
          </tr>
        </tal:block>
        <tal:block tal:condition="not: select_node_category">
          <tr>
            <td>assertSelected</td>
            <td>//select[@name="field_your_node_category"]</td>
            <td tal:content='node_category'></td>
          </tr>
        </tal:block>
      </tal:block>
    </tal:block>
  </tal:block>
</tal:block>