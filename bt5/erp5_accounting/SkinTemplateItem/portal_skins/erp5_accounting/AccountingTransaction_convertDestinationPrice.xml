<?xml version="1.0"?>
<ZopeData>
  <record id="1" aka="AAAAAAAAAAE=">
    <pickle>
      <tuple>
        <global name="PythonScript" module="Products.PythonScripts.PythonScript"/>
        <tuple/>
      </tuple>
    </pickle>
    <pickle>
      <dictionary>
        <item>
            <key> <string>Script_magic</string> </key>
            <value> <int>3</int> </value>
        </item>
        <item>
            <key> <string>_bind_names</string> </key>
            <value>
              <object>
                <klass>
                  <global name="NameAssignments" module="Shared.DC.Scripts.Bindings"/>
                </klass>
                <tuple/>
                <state>
                  <dictionary>
                    <item>
                        <key> <string>_asgns</string> </key>
                        <value>
                          <dictionary>
                            <item>
                                <key> <string>name_container</string> </key>
                                <value> <string>container</string> </value>
                            </item>
                            <item>
                                <key> <string>name_context</string> </key>
                                <value> <string>context</string> </value>
                            </item>
                            <item>
                                <key> <string>name_m_self</string> </key>
                                <value> <string>script</string> </value>
                            </item>
                            <item>
                                <key> <string>name_subpath</string> </key>
                                <value> <string>traverse_subpath</string> </value>
                            </item>
                          </dictionary>
                        </value>
                    </item>
                  </dictionary>
                </state>
              </object>
            </value>
        </item>
        <item>
            <key> <string>_body</string> </key>
            <value> <string>from Products.ERP5.Document.Document import ConversionError\n
\n
"""\n
Script to convert the prices used in the transaction to the \n
currency of the destination section\n
form_id : Page that action is called from\n
\n
\n
"""\n
\n
portal = context.getPortalObject()\n
#get the precision of the destination\n
precision =context.getDestinationSectionValue().getPriceCurrencyValue().getQuantityPrecision()\n
#Get all transaction lines of the transaction \n
line_list= context.contentValues(\n
      portal_type=portal.getPortalAccountingMovementTypeList())\n
"""\n
For each transaction line, calculate the price of the resource\n
(i.e. currency in which the transaction is being done) in the \n
context of the transaction line, add the resource, price_currency\n
and start_date categories \n
"""\n
\n
for line in line_list:\n
  if line.getDestinationSectionValue() is None:\n
    raise AssertionError\n
  else:\n
   currency = line.getResourceValue()\n
   exchange_ratio = currency.getPrice(context=line.asContext(\n
                          categories=[\'resource/%s\' % line.getResourceRelativeUrl(), \n
                                \'price_currency/currency_module/%s\' %\n
                      line.getDestinationSectionValue().getPriceCurrencyId()],\n
                      start_date=line.getStopDate()))\n
\n
#redirect to previous page without doing the conversion\n
   if exchange_ratio is None:\n
     return context.Base_redirect(form_id,\n
                                  keep_items=dict(\n
                portal_status_message=context.Base_translateString(\'No exchange ratio found.\'))) \n
#update the corresponding price and round it according to the precision of\n
#the converted currency\n
   line.setDestinationTotalAssetPrice(\n
       round(exchange_ratio*(line.getQuantity())),precision)\n
\n
\n
msg = context.Base_translateString(\'Price converted.\')\n
\n
return context.Base_redirect(form_id,\n
                             keep_items=dict(portal_status_message=msg))\n
</string> </value>
        </item>
        <item>
            <key> <string>_code</string> </key>
            <value>
              <none/>
            </value>
        </item>
        <item>
            <key> <string>_params</string> </key>
            <value> <string>form_id=\'view\'</string> </value>
        </item>
        <item>
            <key> <string>errors</string> </key>
            <value>
              <tuple/>
            </value>
        </item>
        <item>
            <key> <string>func_code</string> </key>
            <value>
              <object>
                <klass>
                  <global name="FuncCode" module="Shared.DC.Scripts.Signature"/>
                </klass>
                <tuple/>
                <state>
                  <dictionary>
                    <item>
                        <key> <string>co_argcount</string> </key>
                        <value> <int>1</int> </value>
                    </item>
                    <item>
                        <key> <string>co_varnames</string> </key>
                        <value>
                          <tuple>
                            <string>form_id</string>
                            <string>Products.ERP5.Document.Document</string>
                            <string>ConversionError</string>
                            <string>_getattr_</string>
                            <string>context</string>
                            <string>portal</string>
                            <string>precision</string>
                            <string>line_list</string>
                            <string>_getiter_</string>
                            <string>line</string>
                            <string>None</string>
                            <string>AssertionError</string>
                            <string>currency</string>
                            <string>exchange_ratio</string>
                            <string>dict</string>
                            <string>round</string>
                            <string>msg</string>
                          </tuple>
                        </value>
                    </item>
                  </dictionary>
                </state>
              </object>
            </value>
        </item>
        <item>
            <key> <string>func_defaults</string> </key>
            <value>
              <tuple>
                <string>view</string>
              </tuple>
            </value>
        </item>
        <item>
            <key> <string>id</string> </key>
            <value> <string>AccountingTransaction_convertDestinationPrice</string> </value>
        </item>
        <item>
            <key> <string>warnings</string> </key>
            <value>
              <tuple/>
            </value>
        </item>
      </dictionary>
    </pickle>
  </record>
</ZopeData>
