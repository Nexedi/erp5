<html>

  <head>
      <link rel="stylesheet" type="text/css" href="gadget_erp5_page_drone_capture_flag_api_page.css">
      <script src="gadget_erp5_page_drone_capture_flag_api_page.js"></script>
      <title>Drone API Documentation</title>
  </head>

  <body>

    <div class="documentation">

      <h1>Artificial Intelligence</h1>

      <h3>Function called by game on event</h3>

        <!-- Start -->
        <h4 class="item-name" id="start"><span>onStart</span><span>: void</span></h4>
        <p class="item-descr">Function called on game start.</p>

        <div>
        <h5 class="item-param-1">Example</h5>
        </div>

        <div>
        <p class="item-param-1">me.onStart = function() {<br>
          &nbsp;&nbsp;me.setAcceleration(1);<br>
          &nbsp;&nbsp;me.setDirection(0,1,0);<br>
          }
        </p>
        </div>

        <div class="line"></div>

        <!-- Update -->
        <h4 class="item-name" id="update"><span>onUpdate</span><span>: void</span></h4>
        <p class="item-descr">Function called on game update, 60 times / second. <br></p>
        <h5 class="item-param-1">Example</h5>
        <p class="item-example">me.onUpdate = function() {<br>
          &nbsp;&nbsp;me.setDirection(Math.random()&nbsp; Math.random(),&nbsp;0);<br>
          }
        </p>

      <div class="line"></div>

        <!-- GetMsg -->
        <h4 class="item-name" id="getMsg"><span>onGetMsg</span><span>: void</span></h4>
        <p class="item-descr">Function called when drone receives a message.</p>

        <div>
          <h5 class="item-param-1">Param</h5>
          <h5 class="item-param-2">Description</h5>
        </div>

        <div>
          <p class="item-param-1">msg: String</p>
          <p class="item-param-2">Content of the message</p>
        </div>

        <div>
        <h5 class="item-param-1">Example</h5>
        </div>

        <div>
        <p class="item-param-1">me.onGetMsg = function (msg) {<br>
          &nbsp;&nbsp; console.log(msg);
          <br> }
        </p>
        </div>

        <div class="line"></div>
        <!-- sendMsg -->
        <h4 class="item-name" id="sendMsg"><span>sendMsg</span><span>: void</span></h4>
        <p class="item-descr">
          Send a message to another drone (or to all team drones).<br>

        <div>
          <h5 class="item-param-1">Param</h5>
          <h5 class="item-param-2">Description</h5>
        </div>

        <div>
          <p class="item-param-1">msg: String</p>
          <p class="item-param-2">The message to send.</p>
        </div>

        <div>
          <p class="item-param-1">id ?: Number</p>
          <p class="item-param-2">ID of the recipient. Leave empty to send to all team drones.</p>
        </div>

        <div>
        <h5 class="item-param-1">Example</h5>
        </div>

        <div>
        <p class="item-example">
          me.sendMsg("My broadcast message");<br>
          me.sendMsg("To my friend 0", 0);
        </p>
        </div>

        <div class="line"></div>
        <!-- Touched -->
        <h4 class="item-name" id="touched"><span>onTouched</span><span>: void</span></h4>
        <p class="item-descr">Function called when drone is touched by another drone.</p>
        <h5 class="item-param-1">Example</h5>
        <p class="item-example">me.onTouched = function() {<br>
          &nbsp;&nbsp;me.sendMsg("Touched");<br>
          &nbsp;&nbsp;//Broadcast message to all drones<br>
          }
        </p>

        <h5 class="item-param-1">Drones collision</h5>
        <p class="item-example">
          The collision between 2 drones is determined by a calculation based on each drone direction, exact position and collision angle, and resolves if one drone bumps the other of if both drones are set down.<br><br>
The simulator engine checks if the drone control masks intersect, and then based on drones directions it calculates the collision angle between them. If the angle is too wide, both drones will fall. If not, the fastest drone will knockdown the slowest one.<br><br>
          The drone mask size is 0.5 x 0.5 (meters)
        </p>
        <div class="line"></div>

        <!-- onCapture -->
        <h4 class="item-name" id="update"><span>onCapture</span><span>: void</span></h4>
        <p class="item-descr">Function called when a fired detection process finishes.<br>
          (a detection process is started when a drone calls isHumanPositionSpotted method, see below)<br>
        </p>

        <div>
          <h5 class="item-param-1">Param</h5>
          <h5 class="item-param-2">Description</h5>
        </div>

        <div>
          <p class="item-param-1">human_found: boolean</p>
          <p class="item-param-2">Result of detection.</p>
        </div>

        <h5 class="item-param-1">Example</h5>
        <p class="item-example">
          me.onCapture = function (human_detected) {<br>
          &nbsp;&nbsp;me.ongoing_detection = false;<br>
          &nbsp;&nbsp;if (human_detected) {<br>
          &nbsp;&nbsp;&nbsp;&nbsp;console.log("HUMAN POSITION FOUND! by drone:", me.id);<br>
          &nbsp;&nbsp;}<br>
          };<br>
        </p>
        <div class="line"></div>

      <h3>Drone property</h3>

        <div class="line"></div>
        <!-- id -->
        <h4 class="item-name" id="id"><span>id</span><span>: number</span></h4>
        <p class="item-descr">
          Drone unique numeric identifier: from 0 to 9.<br><br>
        </p>
        <h5 class="item-param-1">Example</h5>
        <p class="item-example">
          var drone_id = me.id;<br>
        </p>
        <div class="line"></div>

      <h3>Function that drones can call</h3>

        <div class="line"></div>
        <!-- getGameParameter -->
        <h4 class="item-name" id="getGameParameter"><span>getGameParameter</span><span>: string/number/dict</span></h4>
        <p class="item-descr">
          Get game parameter.<br>
          Game parameters are :<br>
          &nbsp;&nbsp;- gameTime : number (in seconds)<br>
          &nbsp;&nbsp;- mapSize  : { depth, height, width } (in meters)<br>
          &nbsp;&nbsp;- teamSize : number<br>
          &nbsp;&nbsp;- derive :<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;speed: number (meters/seconds),<br>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;direction: { x, y }, (coordinates in meters)<br>
          &nbsp;&nbsp;&nbsp;&nbsp;}<br>
          &nbsp;&nbsp;- meteo : [0.5, 0.7, 0.9]<br>
          &nbsp;&nbsp;- initialHumanAreaPosition : { x, y, z } (coordinates in meters)<br>
        </p>

        <div>
        <h5 class="item-param-1">Param</h5>
        <h5 class="item-param-2">Description</h5>
        </div>

        <div>
        <p class="item-param-1">name ?: String</p>
        <p class="item-param-2">Name of the parameter wanted.</p>
        </div>

        <div>
        <h5>Parameters description</h5>
        <p class="item-descr">
          &nbsp;&nbsp;- gameTime: The game time (in seconds).<br>
          &nbsp;&nbsp;- mapSize: Depth, height and width of the map (in meters).<br>
          &nbsp;&nbsp;- teamSize: Amount of drones in the swarm.<br>
          &nbsp;&nbsp;- derive: speed (in meters/seconds) and direction (coordinates vector) of the sea drift (human movement)<br>
          &nbsp;&nbsp;- meteo: wheather conditions that affects drones visibility:<br>
          &nbsp;&nbsp;&nbsp;&nbsp;- 0.5 if 20/35 knots of wind, rain and spray<br>
          &nbsp;&nbsp;&nbsp;&nbsp;- 0.7 if 5/20 Knots of wind, and drizzle<br>
          &nbsp;&nbsp;&nbsp;&nbsp;- 0.9 if 0/5 Knots of wind, sun<br>
          &nbsp;&nbsp;- initialHumanAreaPosition: estimated human initial location with 1km error margin<br>
        </p>
        </div>

        <div>
        <h5 class="item-param-1">Example</h5>
        </div>

        <div>
        <p class="item-example">
          var team_size = me.getGameParameter("teamSize")<br>
          console.log(team_size);<br>
        </p>
        </div>

        <div class="line"></div>
        <!-- isHumanPositionSpotted -->
        <h4 class="item-name" id="isHumanPositionSpotted"><span>isHumanPositionSpotted</span><span>: void</span></h4>
        <p class="item-descr">
          By calling this method, the drone detection process is fired. It checks if the human is under the drone view (at the moment of the call).<br>
          The probability to spot the human relies on the drone flight height and the weather conditions.<br>
          Once the detection finishes (2 seconds) the event method onCapture will be called.<br>
        </p>
        <h5 class="item-param-1">Example</h5>
        <p class="item-example">
          if (!me.ongoing_detection) {<br>
          &nbsp;&nbsp;me.ongoing_detection = true;<br>
          &nbsp;&nbsp;//remember! probability and precision of human detection changes depending on drone height<br>
          &nbsp;&nbsp;me.isHumanPositionSpotted();<br>
          }<br>
        </p>

        <div class="line"></div>
        <!-- getCurrentPosition -->
        <h4 class="item-name" id="getCurrentPosition"><span>getCurrentPosition</span><span>: dictionary</span></h4>
        <p class="item-descr">
          Get drone current position coordinates (coordinates in meters).<br>
          {<br>
          &nbsp;&nbsp;x: number,<br>
          &nbsp;&nbsp;y: number,<br>
          &nbsp;&nbsp;z: number<br>
          }<br>
        </p>
        <h5 class="item-param-1">Example</h5>
        <p class="item-example">
          var current_position = me.getCurrentPosition();<br>
          console.log(current_position);<br>
        </p>
        <div class="line"></div>

        <!-- reportHumanPosition -->
        <h4 class="item-name" id="reportHumanPosition"><span>reportHumanPosition</span><span>: void</span></h4>
        <p class="item-descr">
          Reports to base that the drone has spotted the human and sends a position as parameter.<br>
          This method call finishes the game.<br>
        </p>

        <div>
          <h5 class="item-param-1">Param</h5>
          <h5 class="item-param-2">Description</h5>
        </div>

        <div>
          <p class="item-param-1">position: dict x,y,z</p>
          <p class="item-param-2">Position to be reported as the human position.</p>
        </div>
        <h5 class="item-param-1">Example</h5>
        <p class="item-example">
          me.reportHumanPosition(me.getCurrentPosition())<br>
        </p>

        <div class="line"></div>

        <!-- setAcceleration -->
        <h4 class="item-name" id="setAcceleration"><span>setAcceleration</span><span>: void</span></h4>
        <p class="item-descr">
          Set the drone acceleration (meters/seconds^2). A 0 (zero) acceleration will result in a drone with constant speed.
        </p>

        <div>
          <h5 class="item-param-1">Param</h5>
          <h5 class="item-param-2">Description</h5>
        </div>

        <div>
          <p class="item-param-1">factor: Number</p>
          <p class="item-param-2">Drone will accelerate by this number (meter / second^2).</p>
        </div>

        <div>
        <h5 class="item-param-1">Example</h5>
        </div>

        <div>
        <p class="item-example">
          me.setAcceleration(6);
        </p>
        </div>

        <div class="line"></div>
        <!-- setDirection -->
        <h4 class="item-name" id="setDirection"><span>setDirection</span><span>: void</span></h4>
        <p class="item-descr">
          Set the drone movement direction via a coordinates vector. Coordinates are drone space relative: (0,0) is the drone.
        </p>

        <div>
          <h5 class="item-param-1">Param</h5>
          <h5 class="item-param-2">Description</h5>
        </div>

        <div>
          <p class="item-param-1">X: Number</p>
          <p class="item-param-2">X direction.</p>
        </div>

        <div>
          <p class="item-param-1">Y: Number</p>
          <p class="item-param-2">Y direction.</p>
        </div>

        <div>
          <p class="item-param-1">Z: Number</p>
          <p class="item-param-2">Z direction.</p>
        </div>

        <div>
        <h5 class="item-param-1">Example</h5>
        </div>

        <div>
        <p class="item-example">
          // See schema below<br>
          me.setDirection(1,1,0); //this vector moves the drone in a 45º angle from the x-axis<br>
          // As the vector will be internally normalized, it could be any coordinate:<br>
          me.setDirection(2,-3,0);<br>
          // Another example, move the drone right up<br>
          me.setDirection(0,0,1);<br>
        </p>
        </div>

        <div class="line"></div>
        <!-- setTargetCoordinates -->
        <h4 class="item-name" id="setTargetCoordinates"><span>setTargetCoordinates</span><span>: dictionary</span></h4>
        <p class="item-descr">
          Set a target point expressed in coordinates (in meters). The drone will move straight to this point. Coordinates here are world relative: (0,0) is the center of the map.
        </p>

        <div>
          <h5 class="item-param-1">Param</h5>
          <h5 class="item-param-2">Description</h5>
        </div>

        <div>
          <p class="item-param-1">X: Number</p>
          <p class="item-param-2">X value - depth.</p>
        </div>
        <div>
          <p class="item-param-1">Y: Number</p>
          <p class="item-param-2">Y value - width.</p>
        </div>
        <div>
          <p class="item-param-1">Z: Number</p>
          <p class="item-param-2">Z value - height.</p>
        </div>

        <div>
        <h5 class="item-param-1">Example</h5>
        </div>

        <div>
          <p class="item-example">
            pos = me.initialHumanAreaPosition()<br>
            me.setTargetCoordinates(pos.x, pos.y, pos.z);<br>
            //Another example, move the drone to the center of the map:<br>
            me.setTargetCoordinates(0, 0, height);<br>
          </p>
        </div>

      <div class="line"></div>

      <h3 class="category-name">Drone Physics Schema</h3>
      <center><img src="assets/schema.png"></center>


      <h1>Example scripts</h1>

      <h3>Drone communication</h3>

        <pre>
          //************************* DRONES COMMUNICATION *******************************

          /**
           * This strategy aligns all drone starting positions in a row so they can cover more area
           * This is done by splitting the map x axis into sectors and assigning a sector per drone
           * Drone are sort by their initial x position
           * To achieve the strategy, all drones must communicate their positions to the rest
          **/

          /**
           * During the start, the strategy information for each drone is initialized
          **/
          me.onStart = function() {
            /**
             * Do not move the drone until the strategy is initialized
             * and communicated to all drones
            **/
            me.setAcceleration(0);
            me.initialized = false;
            /**
             * Dictionary with all drone information and map sector assignments
             * It will be filled with information received from the drones
            **/
            me.strategy_info = {
              'started': false,
              'map_size': null,
              'team_size': null,
              'init_drone_count': 0,
              'drones_x_position': {},
              'sector_assignements': {}
            };
            /**
             * Get and store global information like (team size, map size)
            **/
            me.strategy_info.team_size = me.getGameParameter("teamSize");
            me.strategy_info.map_size = me.getGameParameter("mapSize");
            //custom flag to control if drone has detected the human
            me.human_detected = false;
            //custom flag to control the detection process
            me.ongoing_detection = false;
          };

          /**
           * On every update (60 per second) checks drone strategy
          **/
          me.onUpdate = function () {
            /**
             * If drone didn't send its information to others yet, initialize it
            **/
            if (!me.initialized) {
              return initializeDrone(me);
            }
            /**
             * If drone was initialized but it has no map sector assigned, assigne it
            **/
            if (!me.strategy_info.started && me.strategy_info.sector_assignements.hasOwnProperty(me.id)) {
              return sendDroneToAssignedSector(me);
            }
            /**
             * When drone has a sector assigned, move it by setting a direction and acceleration
            **/
            if (me.strategy_info.started) {
              if (!me.ongoing_detection) {
                me.ongoing_detection = true;
                //remember! probability and precision of human detection changes depending on drone height
                me.isHumanPositionSpotted();
              }/* else {
              //here drone could do something different. stop and wait for example
              }*/
              if (!me.human_detected) {
                checkDirection(me);
              }
            }
          };

          /**
           * This method is called when a drone finishes a capture/detection process
          **/
          me.onCapture = function (human_detected) {
            me.ongoing_detection = false;
            if (human_detected) {
              //here drone could do something different.
              //check height and confirm/refine human position or notify others for example
              console.log("HUMAN POSITION FOUND! by drone:", me.id);
              //set the custom drone flag
              me.human_detected = true;
              //report the human found information (this finishes the simulation)
              me.reportHumanPosition(me.getCurrentPosition());
              //notify others example
              var msg = {
                type: 'human-found',
                position: me.getCurrentPosition()
              };
              me.sendMsg(msg);
            }
          };

          /**
           * Manage received message
          **/
          me.onGetMsg = function (msg) {
            /**
             * If message is a drone init information, store it
            **/
            if (msg.type === 'info') {
              if (!me.strategy_info.drones_x_position.hasOwnProperty(msg.drone)) {
                me.strategy_info.drones_x_position[msg.drone] = msg.position.x;
                me.strategy_info.init_drone_count++;
              }
              /**
               * If all drones had communicated the starting info, calculate the strategy
              **/
              if (me.strategy_info.init_drone_count === me.strategy_info.team_size) {
                calculateSectorAssignements(me);
              }
            }
            if (msg.type === 'human-found' && !me.human_detected) {
              //drone is notified about human found
              me.human_detected = true;
              //here the search could be refined
              //forward message to others
              me.sendMsg(msg);
            }
          };

          /**
           * Drone sends its information to others
          **/
          function initializeDrone(drone) {
            var msg = {
              type: 'info',
              drone: drone.id,
              position: drone.position
            };
            drone.sendMsg(msg);
            drone.initialized = true;
          }

          /**
           * Send the drone to the assigned map sector by setting direction and acceleration
           * If the drone reached its map sector, stop it
          **/
          function sendDroneToAssignedSector(drone) {
            var sector_position = getSectorCoordinates(drone);
            drone.setTargetCoordinates(sector_position.x, sector_position.y, sector_position.z);
            if (distance(drone.position, sector_position) < 1) {
              //move the drone straight in y axis
              me.setDirection(0,1,0);
              drone.strategy_info.started = true;
            }
          }

          /**
           * Calculate coordinates of the given map sector
          **/
          function getSectorCoordinates(drone) {
            var sector = drone.strategy_info.sector_assignements[drone.id],
              map_width = drone.strategy_info.map_size.width,
              drone_count = drone.strategy_info.init_drone_count,
              z_coordinate = 12,
              y_coordinate = 3 - drone.strategy_info.map_size.depth/2,
              x_coordinate = (map_width/drone_count)/2 + map_width/drone_count * sector - map_width/2;
            return {x:x_coordinate, y: y_coordinate, z: z_coordinate};
          }

          /**
           * Tiny util function to get the distance between 2 points
          **/
          function distance(a, b) {
              return (a.x - b.x) ** 2 + (a.y - b.y) ** 2 + (a.z - b.z) ** 2;
          }

          /**
           * Sort the drones by their x starting position
           * and assign the corresponding map sector to each
          **/
          function calculateSectorAssignements(drone) {
            var i, items = Object.keys(drone.strategy_info.drones_x_position).map(function(key) {
              return [key, drone.strategy_info.drones_x_position[key]];
            });
            items.sort(function(first, second) {
              return first[1] - second[1];
            });
            for (i = 0; i < items.length; i += 1) {
              drone.strategy_info.sector_assignements[items[i][0]] = i;
            }
          }

          /**
           * Custom function that reads the drone position information and
           * changes the drone direction in case it is in the map limits
          **/
          function checkDirection(drone) {
            var new_x = drone.direction.x, new_y = drone.direction.y,
              new_z = drone.direction.z, change = false;
            if (Math.abs(drone.position.x) > drone.strategy_info.map_size.width / 2 ||
              Math.abs(drone.position.y) > drone.strategy_info.map_size.depth / 2 ||
              Math.abs(drone.position.z) < 10.2 || Math.abs(drone.position.z) > 99.8) {
              new_x = Math.random() * -1 * Math.sign(drone.direction.x);
              if (!new_x) new_x = Math.random();
              new_y = Math.random() * -1 * Math.sign(drone.direction.y);
              if (!new_y) new_y = Math.random();
              new_z = (Math.random() * (0.12 - 0.05) + 0.05) * -1 * Math.sign(drone.direction.z);
              change = true;
            }
            if (change) {
              drone.setDirection(new_x,new_y,new_z);
            }
          }

        </pre>
      
    </div>

  </body>
</html>