<html>

  <head>
      <link rel="stylesheet" type="text/css" href="gadget_erp5_page_drone_capture_flag_api_page.css">
      <script src="gadget_erp5_page_drone_capture_flag_api_page.js"></script>
      <title>Drone API Documentation</title>
  </head>

  <body>

    <div class="documentation">

      <h1>Fixed Wings Drone API</h1>

      <h3>API functions</h3>

      <h3>Functions called by game on event</h3>

      <!-- Start -->
      <h4 class="item-name" id="start"><span>onStart</span><span>: void</span></h4>
      <p class="item-descr">Function called on game start.</p>

      <div>
        <h5 class="item-param-1">Example</h5>
      </div>

      <p class="item-param-1">me.onStart = function() {<br>
        &nbsp;&nbsp;//one time execution code<br>
        }
      </p>

      <div class="line"></div>

      <!-- Update -->
      <h4 class="item-name" id="update"><span>onUpdate</span><span>: void</span></h4>
      <p class="item-descr">Function called on game update, 60 times / second. <br></p>

      <div>
        <h5 class="item-param-1">Param</h5>
        <h5 class="item-param-2">Description</h5>
      </div>

      <div>
        <p class="item-param-1">timestamp: Integer</p>
        <p class="item-param-2">Timestamp in milliseconds from UNIX epoch</p>
      </div>

      <h5 class="item-param-1">Example</h5>

      <p class="item-example">me.onUpdate = function() {<br>
        &nbsp;&nbsp;//code executed 60 times per second<br>
        }
      </p>

      <div class="line"></div>

      <!-- Touched -->
      <h4 class="item-name" id="touched"><span>onTouched</span><span>: void</span></h4>
      <p class="item-descr">Function called when drone is touched by another drone.</p>

      <h5 class="item-param-1">Example</h5>

      <p class="item-example">me.onTouched = function() {<br>
        &nbsp;&nbsp;//code executed when drone is touched<br>
        }
      </p>

      <h5 class="item-param-1">Drones collision</h5>

      <p class="item-example">
        The collision between 2 drones is determined by a calculation based on each drone direction, exact position and collision angle, and resolves if one drone bumps the other of if both drones are set down.
        <br><br>
        The simulator engine checks if the drone control masks intersect, and then based on drones directions it calculates the collision angle between them. If the angle is too wide, both drones will fall. If not, the fastest drone will knockdownÂ the slowest one.
        <br><br>
        The drone mask size is 0.5 x 0.5 (meters)
      </p>

      <div class="line"></div>

      <!-- onDroneViewInfo -->
      <h4 class="item-name" id="update"><span>onDroneViewInfo</span><span>: void</span></h4>
      <p class="item-descr">Function called when a fired detection process finishes.<br>
        (a detection process is started when a drone calls getDroneViewInfo method, see below)<br>
      </p>

      <div>
        <h5 class="item-param-1">Param</h5>
        <h5 class="item-param-2">Description</h5>
      </div>

      <div>
        <p class="item-param-1">drone_view: dict</p>
        <p class="item-param-2">Result of detection.</p>
      </div>

      <h5 class="item-param-1">Example</h5>
      <p class="item-example">
        me.getDroneViewInfo = function (drone_view) {<br>
        &nbsp;&nbsp;//code executed when getDroneViewInfo finished<br>
        }
      </p>

      <div class="line"></div>

      <!-- GetMsg -->
      <h4 class="item-name" id="getMsg"><span>onGetMsg</span><span>: void</span></h4>
      <p class="item-descr">Function called when drone receives a message.</p>

      <div>
        <h5 class="item-param-1">Param</h5>
        <h5 class="item-param-2">Description</h5>
      </div>

      <div>
        <p class="item-param-1">msg: String</p>
        <p class="item-param-2">Content of the message</p>
      </div>

      <div>
        <h5 class="item-param-1">Example</h5>
      </div>

      <div>
        <p class="item-param-1">me.onGetMsg = function (msg) {<br>
          &nbsp;&nbsp;//process the msg
          <br> }
        </p>
      </div>

      <div class="line"></div>

      <h3>Function that drones can call</h3>

      <div class="line"></div>

      <!-- sendMsg -->
      <h4 class="item-name" id="sendMsg"><span>sendMsg</span><span>: void</span></h4>
      <p class="item-descr">Sends a message to another drone (or to all team drones).<p>

      <div>
        <h5 class="item-param-1">Param</h5>
        <h5 class="item-param-2">Description</h5>
      </div>

      <div>
        <p class="item-param-1">msg: String</p>
        <p class="item-param-2">The message to send.</p>
      </div>

      <div>
        <p class="item-param-1">id ?: Number</p>
        <p class="item-param-2">ID of the recipient. Leave empty to send to all team drones.</p>
      </div>

      <div>
        <h5 class="item-param-1">Example</h5>
      </div>

      <div>
        <p class="item-example">
          me.sendMsg("My broadcast message");<br>
          me.sendMsg("To my friend 0", 0);
        </p>
      </div>

      <div class="line"></div>

      <!-- getCurrentPosition -->
      <h4 class="item-name" id="getCurrentPosition"><span>getCurrentPosition</span><span>: dictionary</span></h4>
      <p class="item-descr">
        Get drone current position geo-coordinates.<br>
        {<br>
        &nbsp;&nbsp;x: number, //latitude (in degrees)<br>
        &nbsp;&nbsp;y: number, //longitude (in degrees)<br>
        &nbsp;&nbsp;z: number  //altitude (in meters)<br>
        }<br>
      </p>

      <h5 class="item-param-1">Example</h5>

      <p class="item-example">
        var current_position = me.getCurrentPosition();<br>
        console.log(current_position);<br>
      </p>

      <div class="line"></div>

      <!-- getDroneViewInfo -->
      <h4 class="item-name" id="getDroneViewInfo"><span>getDroneViewInfo</span><span>: void</span></h4>
      <p class="item-descr">
        By calling this method, the drone detection process is fired. It will get all the view information within its scope.<br>
        Once the detection finishes (2 seconds) the event method onDroneViewInfo will be called.<br>
      </p>

      <h5 class="item-param-1">Example</h5>

      <p class="item-example">
        if (!me.ongoing_detection) {<br>
        &nbsp;&nbsp;me.ongoing_detection = true;<br>
        &nbsp;&nbsp;me.getDroneViewInfo();<br>
        &nbsp;&nbsp;me.ongoing_detection = true;<br>
        }<br>
      </p>

      <div class="line"></div>

      <!-- setTargetCoordinates -->
      <h4 class="item-name" id="setTargetCoordinates"><span>setTargetCoordinates</span><span>: dictionary</span></h4>
      <p class="item-descr">
        Set a target point expressed in geo coordinates. The drone will move straight to this point.
      </p>

      <div>
        <h5 class="item-param-1">Param</h5>
        <h5 class="item-param-2">Description</h5>
      </div>

      <div>
        <p class="item-param-1">X: Float</p>
        <p class="item-param-2">X value - latitude (in degrees).</p>
      </div>
      <div>
        <p class="item-param-1">Y: Float</p>
        <p class="item-param-2">Y value - longitude (in degrees).</p>
      </div>
      <div>
        <p class="item-param-1">Z: Float</p>
        <p class="item-param-2">Z value - altitude (in meters).</p>
      </div>

      <div>
      <h5 class="item-param-1">Example</h5>
      </div>

      <div>
        <p class="item-example">
          me.setTargetCoordinates(lat, lon, altitude);<br>
        </p>
      </div>

      <div class="line"></div>

      <h3>Drone properties</h3>

      <!-- id -->
      <h4 class="item-name" id="id"><span>id</span><span>: number</span></h4>
      <p class="item-descr">
        Drone unique numeric identifier: from 0 to 9.<br><br>
      </p>

      <h5 class="item-param-1">Example</h5>

      <p class="item-example">
        var drone_id = me.id;<br>
      </p>

      <div class="line"></div>

      <h3 class="category-name">Drone Physics Schema</h3>
      <center><img src="assets/schema.png"></center>


      <h1>Example scripts</h1>

      <h3>Drone communication</h3>

        <pre>
          //************************* DRONES COMMUNICATION *******************************

          /**
           * This strategy aligns all drone starting positions in a row so they can cover more area
           * This is done by splitting the map x axis into sectors and assigning a sector per drone
           * Drone are sort by their initial x position
           * To achieve the strategy, all drones must communicate their positions to the rest
          **/

          /**
           * During the start, the strategy information for each drone is initialized
          **/
          me.onStart = function() {
            /**
             * Do not move the drone until the strategy is initialized
             * and communicated to all drones
            **/
            me.setAcceleration(0);
            me.initialized = false;
            /**
             * Dictionary with all drone information and map sector assignments
             * It will be filled with information received from the drones
            **/
            me.strategy_info = {
              'started': false,
              'map_size': null,
              'team_size': null,
              'init_drone_count': 0,
              'drones_x_position': {},
              'sector_assignements': {}
            };
            /**
             * Get and store global information like (team size, map size)
            **/
            me.strategy_info.team_size = me.getGameParameter("teamSize");
            me.strategy_info.map_size = me.getGameParameter("mapSize");
            //custom flag to control if drone has detected the human
            me.human_detected = false;
            //custom flag to control the detection process
            me.ongoing_detection = false;
          };

          /**
           * On every update (60 per second) checks drone strategy
          **/
          me.onUpdate = function () {
            /**
             * If drone didn't send its information to others yet, initialize it
            **/
            if (!me.initialized) {
              return initializeDrone(me);
            }
            /**
             * If drone was initialized but it has no map sector assigned, assigne it
            **/
            if (!me.strategy_info.started && me.strategy_info.sector_assignements.hasOwnProperty(me.id)) {
              return sendDroneToAssignedSector(me);
            }
            /**
             * When drone has a sector assigned, move it by setting a direction and acceleration
            **/
            if (me.strategy_info.started) {
              if (!me.ongoing_detection) {
                me.ongoing_detection = true;
                //remember! probability and precision of human detection changes depending on drone height
                me.isHumanPositionSpotted();
              }/* else {
              //here drone could do something different. stop and wait for example
              }*/
              if (!me.human_detected) {
                checkDirection(me);
              }
            }
          };

          /**
           * This method is called when a drone finishes a capture/detection process
          **/
          me.onCapture = function (human_detected) {
            me.ongoing_detection = false;
            if (human_detected) {
              //here drone could do something different.
              //check height and confirm/refine human position or notify others for example
              console.log("HUMAN POSITION FOUND! by drone:", me.id);
              //set the custom drone flag
              me.human_detected = true;
              //report the human found information (this finishes the simulation)
              me.reportHumanPosition(me.getCurrentPosition());
              //notify others example
              var msg = {
                type: 'human-found',
                position: me.getCurrentPosition()
              };
              me.sendMsg(msg);
            }
          };

          /**
           * Manage received message
          **/
          me.onGetMsg = function (msg) {
            /**
             * If message is a drone init information, store it
            **/
            if (msg.type === 'info') {
              if (!me.strategy_info.drones_x_position.hasOwnProperty(msg.drone)) {
                me.strategy_info.drones_x_position[msg.drone] = msg.position.x;
                me.strategy_info.init_drone_count++;
              }
              /**
               * If all drones had communicated the starting info, calculate the strategy
              **/
              if (me.strategy_info.init_drone_count === me.strategy_info.team_size) {
                calculateSectorAssignements(me);
              }
            }
            if (msg.type === 'human-found' && !me.human_detected) {
              //drone is notified about human found
              me.human_detected = true;
              //here the search could be refined
              //forward message to others
              me.sendMsg(msg);
            }
          };

          /**
           * Drone sends its information to others
          **/
          function initializeDrone(drone) {
            var msg = {
              type: 'info',
              drone: drone.id,
              position: drone.position
            };
            drone.sendMsg(msg);
            drone.initialized = true;
          }

          /**
           * Send the drone to the assigned map sector by setting direction and acceleration
           * If the drone reached its map sector, stop it
          **/
          function sendDroneToAssignedSector(drone) {
            var sector_position = getSectorCoordinates(drone);
            drone.setTargetCoordinates(sector_position.x, sector_position.y, sector_position.z);
            if (distance(drone.position, sector_position) < 1) {
              //move the drone straight in y axis
              me.setDirection(0,1,0);
              drone.strategy_info.started = true;
            }
          }

          /**
           * Calculate coordinates of the given map sector
          **/
          function getSectorCoordinates(drone) {
            var sector = drone.strategy_info.sector_assignements[drone.id],
              map_width = drone.strategy_info.map_size.width,
              drone_count = drone.strategy_info.init_drone_count,
              z_coordinate = 12,
              y_coordinate = 3 - drone.strategy_info.map_size.depth/2,
              x_coordinate = (map_width/drone_count)/2 + map_width/drone_count * sector - map_width/2;
            return {x:x_coordinate, y: y_coordinate, z: z_coordinate};
          }

          /**
           * Tiny util function to get the distance between 2 points
          **/
          function distance(a, b) {
              return (a.x - b.x) ** 2 + (a.y - b.y) ** 2 + (a.z - b.z) ** 2;
          }

          /**
           * Sort the drones by their x starting position
           * and assign the corresponding map sector to each
          **/
          function calculateSectorAssignements(drone) {
            var i, items = Object.keys(drone.strategy_info.drones_x_position).map(function(key) {
              return [key, drone.strategy_info.drones_x_position[key]];
            });
            items.sort(function(first, second) {
              return first[1] - second[1];
            });
            for (i = 0; i < items.length; i += 1) {
              drone.strategy_info.sector_assignements[items[i][0]] = i;
            }
          }

          /**
           * Custom function that reads the drone position information and
           * changes the drone direction in case it is in the map limits
          **/
          function checkDirection(drone) {
            var new_x = drone.direction.x, new_y = drone.direction.y,
              new_z = drone.direction.z, change = false;
            if (Math.abs(drone.position.x) > drone.strategy_info.map_size.width / 2 ||
              Math.abs(drone.position.y) > drone.strategy_info.map_size.depth / 2 ||
              Math.abs(drone.position.z) < 10.2 || Math.abs(drone.position.z) > 99.8) {
              new_x = Math.random() * -1 * Math.sign(drone.direction.x);
              if (!new_x) new_x = Math.random();
              new_y = Math.random() * -1 * Math.sign(drone.direction.y);
              if (!new_y) new_y = Math.random();
              new_z = (Math.random() * (0.12 - 0.05) + 0.05) * -1 * Math.sign(drone.direction.z);
              change = true;
            }
            if (change) {
              drone.setDirection(new_x,new_y,new_z);
            }
          }

        </pre>
      
    </div>

  </body>
</html>
