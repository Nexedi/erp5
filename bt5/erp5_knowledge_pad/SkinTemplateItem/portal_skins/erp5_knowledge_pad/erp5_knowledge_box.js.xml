<?xml version="1.0"?>
<ZopeData>
  <record id="1" aka="AAAAAAAAAAE=">
    <pickle>
      <global name="File" module="OFS.Image"/>
    </pickle>
    <pickle>
      <dictionary>
        <item>
            <key> <string>_Cacheable__manager_id</string> </key>
            <value> <string>http_cache</string> </value>
        </item>
        <item>
            <key> <string>_EtagSupport__etag</string> </key>
            <value> <string>ts94407027.22</string> </value>
        </item>
        <item>
            <key> <string>__name__</string> </key>
            <value> <string>erp5_knowledge_box.js</string> </value>
        </item>
        <item>
            <key> <string>content_type</string> </key>
            <value> <string>application/javascript</string> </value>
        </item>
        <item>
            <key> <string>data</string> </key>
            <value> <string encoding="cdata"><![CDATA[

// global layout is saved here\n
var last_layout = \'\';\n
\n
// current active pad relative url\n
var active_knowledge_pad_relative_url = \'\';\n
var active_knowledge_pad_title_dom_id = \'\';\n
\n
// enable or disable integration with server\n
var is_knowledge_template_used = 0;\n
\n
// dictionary of invisible gadgets\n
var invisible_gadgets={};\n
\n
function createCustomKnowledgePadOnServer(){\n
  d = MochiKit.Async.doSimpleXMLHttpRequest("ERP5Site_createDefaultKnowledgePadListForUser", \n
                                            {\'mode\': mode,\n
                                             \'default_pad_group\': default_pad_group});\n
  d.addCallback(handleServerSuccess);\n
  function handleServerSuccess(res){\n
    response = res.responseText;\n
    window.location=cancel_url + \'/view?active_pad_url=\'+response;}\n
}\n
\n
function showCreateDefaultKnowledgePadWarningMessage(){\n
  user_choice = confirm("In order to complete operation you must have your own tab on server instead of the default one which you are currently using and which you can not change.Is it OK to create new one for you now?");\n
  if (user_choice==true){\n
    createCustomKnowledgePadOnServer();}\n
}\n
\n
function handleServerError(res){\n
  /*alert(\'Error on server\');*/\n
};\n
\n
function createCookie(name, value, days, path) {\n
  if (days){\n
    var date = new Date();\n
    date.setTime(date.getTime()+(days*24*60*60*1000));\n
    var expires = "; expires="+date.toGMTString();}\n
  else var expires = "";\n
  if (!path){var path=\'/\';}\n
  document.cookie = name+"="+value+expires+"; path="+path;\n
}\n
\n
function updater(url, box_relative_url, dom_id, \n
                 parent_web_section_url, editable_mode, additionnal_request_params){\n
  /* request box content from server */\n
  request_params = {};\n
  /* getting parameters for the request in the form\'s hidden inputs */\n
  inputs =  MochiKit.DOM.getElement(dom_id).getElementsByTagName(\'input\');\n
  forEach(inputs, function (input){\n
    if(input.type == \'hidden\'){\n
      // turn \'gadget_form_id\' into \'form_id\'\n
      if(input.name == \'gadget_form_id\'){\n
        request_params[\'form_id\'] = input.value;}\n
      else if(input.name.substring(input.name.length,input.name.length-5) == \':list\'){\n
        if(typeof(request_params[input.name]) == \'undefined\'){\n
          request_params[input.name] = new Array()\n
        }\n
        request_params[input.name].push(input.value);\n
      }\n
      else{\n
        request_params[input.name] = input.value;\n
      }\n
    }\n
  });\n
\n
  /*getting parameters for request from the parameter additionnal_request_params*/\n
  forEach(keys(additionnal_request_params), function (key){\n
    request_params[key] = additionnal_request_params[key];\n
  });\n
\n
  request_params[\'box_relative_url\'] = box_relative_url;\n
  request_params[\'parent_web_section_url\'] = parent_web_section_url; \n
  request_params[\'is_gadget_mode:int\'] = 1; \n
  request_params[\'editable_mode:int\'] = editable_mode; \n
\n
  MochiKit.DOM.getElement(dom_id).style.opacity = 0.5;\n
  d = MochiKit.Async.doSimpleXMLHttpRequest(url, request_params);\n
  d.addCallbacks(handleServerSuccess, handleServerError);\n
  function handleServerSuccess(res){\n
    content_type = res.getResponseHeader(\'Content-Type\');\n
    if(content_type.search("application/json")!=-1){\n
      /* server returned JSON which may contain HTML & JavaScript */\n
      text = res.responseText \n
      json_dict = evalJSON(text);\n
      html = json_dict[\'body\'];\n
      eval(json_dict[\'javascript\']);}\n
    else{\n
      /* server returned HTML */\n
      html = res.responseText;}\n
      /* set HTML as returned from server */\n
    MochiKit.DOM.getElement(dom_id).innerHTML = html;\n
    MochiKit.DOM.getElement(dom_id).style.opacity = 1.0;};\n
      \n
  function handleServerError(res){\n
    MochiKit.DOM.getElement(dom_id).innerHTML = \'Server side error.\';\n
    MochiKit.DOM.getElement(dom_id).style.opacity = 1.0;};\n
}\n
\n
function checkForActivitiesOnServer(timeout, return_url, mode, default_pad_group){\n
  /* check if activities are over and refresh current page */\n
  window.setInterval(\n
    function () {\n
      d = MochiKit.Async.doSimpleXMLHttpRequest(\'ERP5Site_hasUserActivity\',\n
                                                {\'js_call\': 1,\n
                                                 \'mode\': mode,\n
                                                 \'default_pad_group\': default_pad_group});\n
      d.addCallback(handleServerSuccess);\n
      function handleServerSuccess(res){\n
         if(res.responseText==\'False\'){window.location=return_url;}\n
         }}, \n
    timeout);\n
}\n
\n
function stickPadOnWebSection(create_url,\n
                              knowledge_pad_url,\n
                              websection_url,\n
                              cancel_url){\n
  /* stick pad on Web Section and then check if \n
     activities are over and refresh current page */\n
  d = MochiKit.Async.doSimpleXMLHttpRequest(create_url, \n
                                            {\'knowledge_pad_url\': knowledge_pad_url,\n
                                             \'cancel_url\': cancel_url});\n
  d.addCallbacks(handleServerSuccess, handleServerError);\n
  function handleServerSuccess(res){\n
    window.location=cancel_url+\'?active_pad_url=\'+res.responseText;};\n
};\n
\n
function createDefaultPadOnServer(timeout, create_url,\n
                                  default_pad_group, return_url, mode){\n
  /* create default tab on server and then check if \n
     activities are over and refresh current page */\n
  d = MochiKit.Async.doSimpleXMLHttpRequest(create_url, \n
                                            {\'default_pad_group\': default_pad_group,\n
                                             \'mode\': mode});\n
  d.addCallbacks(handleServerSuccess, handleServerError);\n
  function handleServerSuccess(res){\n
    checkForActivitiesOnServer(timeout, return_url, mode, default_pad_group);};\n
};\n
\n
// This function can be used to submit gadget preferences form whenever\n
// an enter is pressed in form\n
function submitGadgetPreferenceFormOnEnter(event, form_fields_main_prefix, box_relative_url){\n
  if(event.keyCode == 13){\n
    submitSynchronousGadgetPreferenceForm(form_fields_main_prefix, box_relative_url);\n
  }\n
}\n
\n
function submitSynchronousGadgetPreferenceForm(\n
                                form_fields_main_prefix, \n
                                box_relative_url){\n
  /* this will add respective gadget knowledge box relative url and\n
     gadget ERP5 preference form field_prefix (so multiple gadgets can \n
     safely coexist in one HTML page with one HTML form */\n
  appendChildNodes(document.forms[0], \n
                   INPUT({\'value\':box_relative_url, \n
                          \'name\': \'box_relative_url\', \n
                          \'type\':\'hidden\'}));\n
  appendChildNodes(document.forms[0], \n
                   INPUT({\'value\':form_fields_main_prefix, \n
                          \'name\': \'form_fields_main_prefix\', \n
                          \'type\':\'hidden\'}));\n
  // append current return URL so we know where to redirect user\n
  redirect_url = window.location.protocol + "//" + window.location.host + window.location.pathname\n
  appendChildNodes(document.forms[0], \n
                   INPUT({\'value\':redirect_url, \n
                          \'name\': "gadget_redirect_url", \n
                          \'type\':\'hidden\'}));\n
  clickSaveButton(\'KnowledgeBox_baseEdit\');\n
};\n
\n
function submitAsynchronousGadgetPreferenceForm(\n
                                 form_dom_id, \n
                                 view_form_url, \n
                                 box_relative_url, \n
                                 visual_block_dom_id, \n
                                 form_fields_main_prefix){\n
  // iterate over all possible form elements within edit form,\n
  // collect them and send to server\n
  var request_str = "?box_relative_url=" + box_relative_url+ "&form_fields_main_prefix=" + form_fields_main_prefix + "&";\n
  forEach(MochiKit.DOM.getElementsByTagAndClassName(\'input\', null, form_dom_id) , function (item) {\n
    if (item.type == "checkbox"){\n
      if (item.checked){request_str+=item.name + \':boolean=True&\';}\n
      else {request_str+=item.name + \':boolean=False&\';}}\n
    if (item.type == "radio"){\n
      if (item.checked){request_str+=item.name + \'=\'+item.value+\'&\';}}\n
    if (item.type == "text"){request_str+=item.name + \'=\' + item.value + \'&\';}\n
    if (item.type == "password"){request_str+=item.name + \'=\' + item.value + \'&\';}\n
  });\n
  forEach(MochiKit.DOM.getElementsByTagAndClassName(\'select\', null, form_dom_id), function (item) {\n
    //support multifield in gadget edit form\n
    if (item.multiple){\n
      forEach(MochiKit.DOM.getElementsByTagAndClassName(\'option\', null, item), function (selection) {\n
        if(selection.selected){\n
          request_str+=item.name + \'=\' + selection.value + \'&\';\n
        }\n
      });\n
    }else{\n
      request_str+=item.name + \'=\' + item.value + \'&\';\n
    }\n
  });\n
\n
  /* save form preferences to remote server*/\n
  url = "KnowledgeBox_baseEdit" + request_str;\n
  d = MochiKit.Async.doSimpleXMLHttpRequest(url);\n
  d.addCallback(handleServerSuccess);\n
  function handleServerSuccess(res){\n
    /* update content view area back from server */\n
    updater(view_form_url, box_relative_url, visual_block_dom_id);\n
    MochiKit.Visual.toggle(form_dom_id);}\n
  };\n
\n
function updateServerBoxColumnLayout(container){\n
  // read columns structure from DOM  ..\n
  var columns_arr = new Array;\n
  var columns = MochiKit.DOM.getElementsByTagAndClassName("div", "portal-column");\n
  // sort alphabetically as it\'s required to get proper layout from DOM\n
  columns.sort(keyComparator("id")); \n
  for (var i = 0; i < columns.length; i++){\n
    column_items = MochiKit.DOM.getElementsByTagAndClassName("div", "block", columns[i]);\n
    var items_arr = new Array;\n
    for (var j = 0; j < column_items.length; j++){\n
        items_arr[j] = column_items[j].id;};\n
    columns_arr[i] = items_arr.join(\'|\')\n
  };\n
  var layout = columns_arr.join(\'##\');\n
  // .. and send it to server only if it\'s different\n
  // XXX: This may bloat ZODB as everry change is a chnage to an ZODB object.\n
  if (layout!=last_layout){\n
    last_layout = layout;\n
    MochiKit.Async.doSimpleXMLHttpRequest("KnowledgePad_saveBoxColumnLayout", {user_layout: layout});\n
    }\n
  return\n
}\n
\n
function addBoxToServer(url, dom_id, gadget_relative_url){\n
  /* add gadget to knowledge pad */\n
  d = MochiKit.Async.doSimpleXMLHttpRequest(url, {gadget_relative_url: gadget_relative_url});\n
  d.addCallback(handleServerSuccess);\n
  function handleServerSuccess(res){\n
    button = MochiKit.DOM.getElement(dom_id);\n
    button.innerHTML = res.responseText;\n
    button.disabled = true;}\n
}\n
\n
function showAddNewPadPopup(){\n
  MochiKit.Visual.toggle(\'add_new_tab_dialog\');\n
  // set focus on new Pad title after toggle effect is over \n
  setTimeout("MochiKit.DOM.getElement(\'new_pad_title\').focus()", 500 );\n
}\n
\n
function showRenamePadPopup(knowledge_pad_relative_url, knowledge_pad_title_dom_id){\n
  // set current active pad\' url & title dom element id\n
  active_knowledge_pad_relative_url = knowledge_pad_relative_url;\n
  active_knowledge_pad_title_dom_id = knowledge_pad_title_dom_id;\n
  // init rename dialog input field to current active pad\n
  MochiKit.DOM.getElement("new_knowledge_pad_title").value = MochiKit.DOM.getElement(knowledge_pad_title_dom_id).innerHTML;\n
  // show rename dialog\n
  MochiKit.Visual.toggle("rename_tab_dialog");\n
  // set focus on new Pad title after toggle effect is over \n
  setTimeout("MochiKit.DOM.getElement(\'new_knowledge_pad_title\').focus()", 500 );\n
}\n
\n
function loadPadFromServer(pad_relative_url, selected_pad_dom_id, mode){\n
  /* Load Pad from server */\n
  //  show some animation\n
  MochiKit.DOM.getElement("loading-wrapper").style.display="block";\n
  \n
  d = MochiKit.Async.loadJSONDoc(\'KnowledgePag_getPadAsJSON\', \n
                                 {\'pad_relative_url\':pad_relative_url,\n
                                  \'mode\':mode});\n
  d.addCallbacks(handleServerSuccess, metadataFetchFailed);\n
\n
  // set old pad to not selected\n
  pads_container = MochiKit.DOM.getElement("tabs");\n
  old_selected_pad = MochiKit.DOM.getFirstElementByTagAndClassName("li", "tab_selected", pads_container);\n
  old_selected_pad.setAttribute("class", "tab");\n
  pad_actions = MochiKit.DOM.getFirstElementByTagAndClassName("div", "pad-actions", old_selected_pad);\n
  pad_actions.style.display="none";\n
  \n
  // set new selected pad class \n
  new_selected_pad = MochiKit.DOM.getElement(selected_pad_dom_id);\n
  new_selected_pad.setAttribute("class", "tab tab_selected");\n
  \n
  // enable "settings" for this pad and hide instant switch\n
  pad_actions = getFirstElementByTagAndClassName("div", "pad-actions", new_selected_pad);\n
  pad_actions.style.display="block";\n
  \n
  // set new active pad\n
  active_knowledge_pad_relative_url = pad_relative_url;\n
  \n
  function metadataFetchFailed(meta){}\n
  \n
  function handleServerSuccess(meta){\n
    body = meta.body\n
    javascript = meta.javascript\n
    body_element = MochiKit.DOM.getElement(\'pad-body-wrapper\');\n
    body_element.innerHTML = body;\n
    // init new Pad\n
    initialize();\n
    // execute JS code provided by server\n
    eval(javascript);\n
    // give some timeout as we can be sometimes two fast loading a tab\n
    setTimeout("MochiKit.DOM.getElement(\'loading-wrapper\').style.display=\'none\';", 250 );\n
  }\n
}\n
\n
function addNewPad(cancel_url, knowledge_pad_relative_url, mode){\n
  // if it\'s first time we switch set active_knowledge_pad_relative_url\n
  if(active_knowledge_pad_relative_url==\'\'){\n
    active_knowledge_pad_relative_url = knowledge_pad_relative_url;\n
  }\n
  // redirect to add gadget dialog\n
  window.location="Base_viewGadgetListDialog?reset=1&cancel_url="+cancel_url+"&active_pad_relative_url="+active_knowledge_pad_relative_url+"&mode="+mode; \n
}\n
\n
function addPadOnServerOnEnter(event, create_url, mode, cancel_url){\n
  /* Catch and submit form when ENTER is pressed */\n
  if(event.keyCode == 13){\n
    addPadOnServer(create_url, mode, cancel_url);\n
    return false;\n
  }\n
}\n
\n
function addPadOnServer(create_url,\n
                        mode,\n
                        cancel_url){\n
  /* add pad on server */\n
  pad_title = MochiKit.DOM.getElement(\'new_pad_title\');\n
  pad_title_value = pad_title.value\n
  window.location = create_url + \'?redirect_url=\' + cancel_url + \'&mode=\' + mode + \'&pad_title=\'+pad_title_value ;\n
};\n
\n
function removeKnowledgePadFromServer(knowledge_pad_relative_url, mode){\n
  /* remove pad from server*/\n
  if (is_knowledge_template_used){\n
    showCreateDefaultKnowledgePadWarningMessage();}\n
  else{\n
    var user_choice = true;\n
    user_choice = confirm("Are you sure you want to remove this pad from your home?");\n
    if (user_choice==true){\n
      location.href="ERP5Site_deleteKnowledgePad?knowledge_pad_relative_url=" + knowledge_pad_relative_url+"&mode="+mode;}\n
    }\n
}\n
\n
function renameKnowledgePadToServerOnEnter(event){\n
  if(event.keyCode == 13){\n
    renameKnowledgePadToServer();\n
    return false;\n
  }\n
  return true;\n
}\n
\n
function renameKnowledgePadToServer(){\n
  if (is_knowledge_template_used){\n
    showCreateDefaultKnowledgePadWarningMessage();}\n
  else{\n
    // rename it locally and update server asynchonously\n
    title_element = MochiKit.DOM.getElement(active_knowledge_pad_title_dom_id)\n
    input_element = MochiKit.DOM.getElement("new_knowledge_pad_title")\n
    var knowledge_pad_title = input_element.value;\n
    title_element.innerHTML = knowledge_pad_title;\n
    MochiKit.Async.doSimpleXMLHttpRequest("ERP5Site_renameKnowledgePad", \n
                                          {knowledge_pad_relative_url: active_knowledge_pad_relative_url,\n
                                           knowledge_pad_title: knowledge_pad_title});\n
  }\n
  //anyway toggle show dialog\n
  MochiKit.Visual.toggle("rename_tab_dialog");\n
}\n
\n
function initialize(){\n
  // define sortable columns\n
  if (is_knowledge_template_used==0){\n
    // allow drag and drop only if we are dealing with a pad we can modify\n
    var sortables = MochiKit.DOM.getElementsByTagAndClassName(\'div\', \'portal-column\');\n
    forEach(sortables, function (item) {\n
      // eliminate undraggable columns by checking exact match\n
      if (item.className==\'portal-column\'){\n
        MochiKit.Sortable.create(item.id,  {"constraint"  : false,\n
                                            "containment" : sortables,\n
                                            "handle": "handle",\n
                                            "only": "block",\n
                                            "tag": "div",\n
                                            "scroll": "true",\n
                                            "hoverclass": "block-hover",\n
                                            "dropOnEmpty": "true",\n
                                            "onUpdate": updateServerBoxColumnLayout,\n
                                            "starteffect" : MochiKit.Base.noop,\n
                                            "endeffect"   : MochiKit.Base.noop\n
                                          });\n
      };\n
    })}\n
\n
  // enable show/hide tabs\n
  tabs = MochiKit.DOM.getElement(\'tabs\');\n
  tabs_switcher = MochiKit.DOM.getElement("tabs_switcher");\n
  add_gadget = MochiKit.DOM.getElement("add_new_gadget_link")\n
  if(tabs_switcher){\n
    connect(tabs_switcher, \'onclick\', function (){\n
      var is_tabs_visible=0;\n
      if(tabs.style.display!=\'block\'){\n
        is_tabs_visible=1;\n
        MochiKit.DOM.getElement("tab_switcher_visible").style.display = "block";\n
        MochiKit.DOM.getElement("tab_switcher_hidden").style.display = "none";\n
        add_gadget.className = "border_bottom1px";\n
        tabs_switcher.className = "border_bottom1px";\n
      }\n
      else{\n
        MochiKit.DOM.getElement("tab_switcher_hidden").style.display = "block";\n
        MochiKit.DOM.getElement("tab_switcher_visible").style.display = "none";\n
        add_gadget.className = "border_bottom0px";\n
        tabs_switcher.className = "border_bottom0px";\n
      }\n
      MochiKit.Visual.toggle(tabs);\n
      createCookie("is_tabs_visible", is_tabs_visible, 365);\n
    });}\n
\n
  // for each box (gadget) add respective event handlers\n
  var boxes = MochiKit.DOM.getElementsByTagAndClassName("div", "block");\n
  forEach(boxes, function (box) {\n
     var edit = MochiKit.DOM.getFirstElementByTagAndClassName(\'a\',\n
                                                 \'block-edit-form\', box);\n
     var edit_form = MochiKit.DOM.getFirstElementByTagAndClassName(\'div\', \n
                                                      \'edit-form\', box);\n
     var remove = MochiKit.DOM.getFirstElementByTagAndClassName(\'a\', \n
                                                   \'block-remove\', box);\n
     var minimize = MochiKit.DOM.getFirstElementByTagAndClassName(\'a\', \n
                                                     \'block-minimize\', box);\n
     var minimize_wrapper = MochiKit.DOM.getFirstElementByTagAndClassName(\'div\', \n
                                                             \'minimize_wrapper\', box);\n
     if(minimize){\n
       connect(minimize, \'onclick\', function (){\n
         if (is_knowledge_template_used){\n
           showCreateDefaultKnowledgePadWarningMessage();}\n
         else{\n
           // togle DOM element (locally)\n
           MochiKit.Visual.toggle(minimize_wrapper);\n
           js_dom_id = box.id + \'_content\';\n
           js_code = invisible_gadgets[js_dom_id];\n
           if (js_code!=undefined){\n
             eval(js_code);\n
             // gadget is now visible, i.e. no need to query server just toggle locally dom\n
             delete invisible_gadgets[js_dom_id];}\n
           // update server \n
           MochiKit.Async.doSimpleXMLHttpRequest("KnowledgeBox_toggleVisibility", \n
                                                 {box_relative_url: box.id});}});\n
       }\n
     if(edit){\n
       connect(edit, \'onclick\', function (){\n
         if (is_knowledge_template_used){\n
           showCreateDefaultKnowledgePadWarningMessage();}\n
         else{MochiKit.Visual.toggle(edit_form);}});\n
      }\n
\n
     if(remove){\n
       connect(remove, \'onclick\', function (){\n
         if (is_knowledge_template_used){\n
           showCreateDefaultKnowledgePadWarningMessage();}\n
         else{\n
              user_choice = confirm("Are you sure you want to remove this gadget from your personalized page?");\n
              if (user_choice==true){\n
                MochiKit.Visual.toggle(box);\n
                MochiKit.Async.doSimpleXMLHttpRequest("KnowledgePad_deleteBox", \n
                                                      {box_relative_url: box.id});}}});\n
      }\n
  });\n
}\n
\n
// call function after load of document\n
MochiKit.DOM.addLoadEvent(initialize);\n


]]></string> </value>
        </item>
        <item>
            <key> <string>precondition</string> </key>
            <value> <string></string> </value>
        </item>
        <item>
            <key> <string>size</string> </key>
            <value> <int>20374</int> </value>
        </item>
        <item>
            <key> <string>title</string> </key>
            <value> <string></string> </value>
        </item>
      </dictionary>
    </pickle>
  </record>
</ZopeData>
